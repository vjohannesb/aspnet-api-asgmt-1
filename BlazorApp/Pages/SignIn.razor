@page "/signin"
<ValidateToken />


<h3>Sign in</h3>
@if (!string.IsNullOrEmpty(_error))
{
    <div class="alert alert-danger">
        <span>@_error</span>
    </div>
}

@if (_signInModel != null)
{
    <EditForm Model="@_signInModel" OnValidSubmit="@Login">
        <DataAnnotationsValidator />
        <div class="form-group">

            <label>Email</label>
            <InputText type="email" id="email" class="form-control"
                       @bind-Value="_signInModel.Email" />

            <ValidationMessage For="() => _signInModel.Email" />

            <label>Password</label>
            <InputText type="password" id="password" class="form-control"
                       @bind-Value="_signInModel.Password" />

            <ValidationMessage For="() => _signInModel.Password" />

            <button type="submit" class="btn btn-success mt-3" disabled=@submitting>
                Sign in
            </button>
            <button @onclick="GoToRegister" class="btn btn-outline-primary mt-3">No account? Register here!</button>
        </div>
    </EditForm>
}



@code {
    private string _error;
    private string _signInUrl = "https://localhost:44330/api/admin/signin";
    private string _validateUrl = "https://localhost:44330/api/admin/validate";
    private bool submitting = false;

    private SignInModel _signInModel;

    protected override async Task OnInitializedAsync()
    {
        _signInModel = new SignInModel();

        _error = string.Empty;
        var response = await apiService.SendToAPIAsync(HttpMethod.Post, _validateUrl, auth: true);
        if (response.IsSuccessStatusCode)
            navigationManager.NavigateTo("/");
    }

    private async Task Login()
    {
        submitting = true;
        _error = string.Empty;
        var response = await apiService.SendToAPIAsync(HttpMethod.Post, _signInUrl, _signInModel);

        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<ResponseModel>();
            await apiService.SaveTokenAsync(result.Result);
            navigationManager.NavigateTo("/", forceLoad: true);
        }
        else
            _error = "Unable to log in. Please try again.";
        submitting = false;
    }

    private void GoToRegister()
        => navigationManager.NavigateTo("/register");
}
